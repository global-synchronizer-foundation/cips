## CIP Delegate-less Automation

<pre>
 CIP: N/A
 Title: Delegateless Automation
 Author: Julien Tinguely
 Comments-Summary: No comments yet
 Status: Draft
 Type: Governance
 Created: 2025-04-21
 Approved: N/A
 License: CC0-1.0
</pre>

## Abstract

This CIP proposes to replace the elected SV delegate mechanism to improve fault tolerance. 
Rather than relying on a single delegate, we propose a solution where all SVs attempt to exercise delegate Daml choices. 
Each applying a random delay tuned to minimize contentions.

## Specification

### All SVs try to exercise delegate choices

In the new implementation, all current choices in _dsoRules_ having _dsoDelegate_ as controller will introduce 
a new optional argument named _sv_ to be used instead.
When the new _delegate-less_ feature flag is enabled and the _splice-dso-governance.dar_ implementing this change is vetted, 
SV Apps will try to execute these choices by passing their own SV PartyId as controller. 
The main challenge is to avoid contentions - concurrent executions of the same choice.

### Minimizing contentions

To avoid SVs attempting a task at the same time and having only one succeeding, 
we are adding a random delay D before each attempt and tweak the canton retry backoff parameter.
Each random delay is uniformly distributed with D ~ N(0, U), where the upper bound U is max(n * t, T) 
with n = number of SVs, t = estimated task duration, T = polling trigger interval (30s)

A new metric named `splice_attempts` is added to measure trigger contentions.

### Remove Delegate Election

In the current implementation, there is a dedicated page to elect a new delegate for the next round, 
aiming to unlock the system if a delegate comes down.
In the new implementation, delegate election will be fully removed, 
associated Daml choices marked as deprecated and the _Delegate Election_ page in the SV UI removed.

## Motivation

A delegate performs critical network-related tasks, such as for example advancing mining rounds or close vote proposals. 
In the current version, many other core processes rely heavily on the delegate, 
with no built-in fault tolerance to mitigate issues that may occur on the node. 
A concerning problem observed multiple times is when a malfunctioning delegate causes mining rounds to stop progressing altogether. 
This has raised concerns among SV operators and highlights the need for an better fault tolerance mechanism.

## Rationale

### Requirements

    * Tolerance of faulty SVs: As long as less than a threshold of SVs is faulty or malicious, 
      all automation should continue to function without significant impact on latency or throughput of tasks processed

    * Minimize Contention: While some contention is likely unavoidable, it should be minimized. 
      Given that SVs do not pay traffic contention is not a problem wrt to traffic costs but it does put additional load on the network.

    * Accountability of SVs: It must be possible to detect whether an SV is faulty or malicious or working as expected with high confidence.

    * Well-Behaved under Load:  Under load where a large number of task piles up, there should be no cascading effects that make things even worse.

### Randomization vs. Task-based seeds

We believe that randomizing the executions between SVs is enough for now. 
However, another approach where we would define the execution order based on a task seed is considered if we need to minimize contention further.

## Backwards compatibility

This new mechanism is only active when all SVs have vetted the new governance dar 
and have set the feature flag _delegatelessAutomation_ in their SV App. 
All choices and backend code involved is backward compatible.

## Reference implementation

The new implementation includes backend and Daml changes. 
An early version of the code is available in <TODO ADD SPLICE GH LINK>.

## Copyright

This CIP is licensed under CC0-1.0: [Creative Commons CC0 1.0 Universal](https://creativecommons.org/publicdomain/zero/1.0/)
