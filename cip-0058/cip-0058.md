## CIP Delegateless Automation

<pre>
 CIP: N/A
 Title: Delegateless Automation
 Author: Julien Tinguely
 Comments-Summary: No comments yet
 Status: Draft
 Type: Governance
 Created: 2025-04-21
 Approved: N/A
 License: CC0-1.0
</pre>

## Abstract

This CIP proposes to replace the elected SV delegate mechanism to improve fault tolerance. 
Instead of relying on a single delegate, we propose an approach where all SV applications attempt to exercise delegate choices. 
Each application will apply a random delay, tuned to minimize contention.

## Specification

### Daml

In the new implementation, all current choices on the `DsoRules` template having `dsoDelegate` as controller will introduce
a new optional argument named `sv` to be used instead. This allows all SVs to exercise the choice by specifying their own party.
Daml will reject a transaction where they try to specify any party other than their own with an authorization error.

### SV Application

The SV application is modified such that all SVs attempt to submit the commands currently only being submitted by the delegate.

This introduces some potential for conflict: if multiple SV applications submit the same transaction at the same time, 
e.g., all attempt to advance the mining rounds at the same time, only one of them will succeed and the others fail, i.e., 
they contend with each other. Importantly, this is not a correctness issue: The Daml code already has to handle this case, 
e.g., if the delegate crashes during a submission and tries to resubmit the same command. But the failed transactions introduce unnecessary load on the network.

To minimize the impact, each SV application adds a random delay before each attempt and retries with a random backoff.
A new metric named `splice_trigger_attempted_total` is added to monitor trigger failures caused by contention and help in choosing good delay and backoff parameters.

### SV UI

In the current implementation, there is a dedicated page in the SV UI to elect a new delegate for the next round, 
intended to unlock the system if a delegate comes down.
In the new implementation, delegate election and its dedicated page in the SV UI are fully removed and 
associated Daml choices cannot be executed anymore.

## Motivation

A delegate performs critical network-related tasks, such as for example advancing mining rounds or executing accepted proposals.
In the current version, there is no automatic fault tolerance to mitigate issues that may occur on the node. 
SVs can vote on a new delegate, but this is a manual process, and the single point of failure is just moved to a different SV.
A concrete problem is rounds stop progressing when the delegate is down.
This has been observed multiple times on devnet and testnet and highlights the need for a better fault tolerance mechanism.

## Rationale

All SV applications attempting to complete tasks provides the right fault tolerance guarantees and introduces no correctness issues as commands are already all idempotent. 

Given that the current delegate-based choices do not require high throughput, e.g., round advancement happens only every 10 minutes,
random delays and backoffs are sufficient to minimize contention.

While more complex approaches to minimize contention would be possible, 
e.g., defining a clear order in which SVs should attempt to process a given task that is determined based on some task identifier, 
the implementation complexity of that does not seem to be justified.

## Backwards compatibility

This new approach is only active when all SV operators have vetted the new governance dar file.
All choices and backend code involved is backward compatible.

## Reference implementation

The new implementation includes backend and Daml changes. 
An early version of the code is available in Splice [branch: feature/delegateless-automation](https://github.com/hyperledger-labs/splice/blob/feature/delegateless-automation/daml/splice-dso-governance/daml/Splice/DsoRules.daml).

## Copyright

This CIP is licensed under CC0-1.0: [Creative Commons CC0 1.0 Universal](https://creativecommons.org/publicdomain/zero/1.0/)
